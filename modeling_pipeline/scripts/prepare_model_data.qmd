---
title: "Build models on Kawakami data: elastic net and xgboost"
author: "Temi"
date: 'Wednesday Oct 26 2022'
format: 
  pdf: 
    toc: true
    number-sections: true
    code-line-numbers: true
---

```{r}
rm(list=ls())

library(glue)
library(reticulate)
library(R.utils)
library(data.table)
library(glmnet)
library(doMC)
library(ROCR)
library(Matrix)
library(reshape2)
library(tidyverse)
library(foreach)
library(doParallel)

```

```{r}
project_dir <- '/lus/grand/projects/covid-ct/imlab/users/temi/projects/TFXcan/modeling_pipeline'
setwd(project_dir)

TF <- 'FOXA1'
id <- 'kawakami'
kawakami_data_dir <- glue('{project_dir}/data/train-test-val/kawakami')
```

```{r}
# using the aggByCenter 
kawakami_center_dt <- data.table::fread(glue('{kawakami_data_dir}/{id}_aggByCenter_{TF}.csv.gz'))
dim(kawakami_center_dt) ; kawakami_center_dt[1:5, 1:5]
```

Ground truth (or class)
```{r}
ground_truth <- data.table::fread(paste0(project_dir, '/../impact_pipeline/motif_intervals/kawakami/ground-truth/', id, '_', TF, '_40000.txt'))
head(ground_truth)
```

```{r}
gt <- ground_truth[ground_truth$V1 %in% kawakami_center_dt$id, ]
dim(gt) ; length(unique(gt$V1))
```

```{r}
find_duplicates_in_dataframe <- function(dt, col, return_dups=TRUE){
  n_occur <- data.frame(table(dt[[col]]))

  if(return_dups == TRUE){
    return(dt[dt[[col]] %in% n_occur$Var1[n_occur$Freq > 1],])
  } else {
    return(n_occur[n_occur$Freq > 1,])
  }
}
```

```{r}
find_duplicates_in_dataframe(gt, col='V1')
```
Keep first occurrence of duplicates
```{r}
gt_dedup <- gt[!duplicated(gt[['V1']]),]
dim(gt_dedup)
```

Merge `gt_dedup` with the data
```{r}
new_dt <- merge(gt_dedup, kawakami_center_dt, by.x='V1', by.y='id')
```

```{r}
new_dt <- new_dt[, -c('class')]
colnames(new_dt)[1:2] <- c('region', 'class')
new_dt[1:5, 1:5] ; dim(new_dt)
```

Split into 80-20
```{r}
set.seed(2022)
tr_size <- ceiling(nrow(new_dt) * 0.8)
tr_indices <- sample(1:nrow(new_dt), tr_size)
```

```{r}
train <- new_dt[tr_indices, ]
test <- new_dt[-tr_indices, ]
```
Save the data
```{r}
save_dir <- paste0(project_dir, '/data/enet_data')

write.csv(x=train, file=gzfile(paste0(save_dir, '/train_enet.csv.gz')))
write.csv(x=test, file=gzfile(paste0(save_dir, '/test_enet.csv.gz')))
```



```{r}
# split the data

X_train <- kawakami_center_dt[, -c(1,2)] |> as.matrix()
y_train <- kawakami_center_dt[, c(1,2)] |> as.data.frame()
```

```{r}
# check the distribution
y_train$class |> table()
```
