<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.0.38">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Temi">

<title>TF binding analysis | Using Enformer and IMPACT</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="impact-enformer-modelling_files/libs/clipboard/clipboard.min.js"></script>
<script src="impact-enformer-modelling_files/libs/quarto-html/quarto.js"></script>
<script src="impact-enformer-modelling_files/libs/quarto-html/popper.min.js"></script>
<script src="impact-enformer-modelling_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="impact-enformer-modelling_files/libs/quarto-html/anchor.min.js"></script>
<link href="impact-enformer-modelling_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="impact-enformer-modelling_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="impact-enformer-modelling_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="impact-enformer-modelling_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="impact-enformer-modelling_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">TF binding analysis | Using Enformer and IMPACT</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Temi </p>
          </div>
  </div>
    
    
  </div>
  

</header>

<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">fig.width=</span><span class="dv">12</span>, <span class="at">fig.height=</span><span class="dv">8</span>, <span class="at">cache=</span>F)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rm</span>(<span class="at">list=</span><span class="fu">ls</span>())</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/scripts/'</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(GenomicRanges)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reticulate)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R.utils)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glmnet)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doMC)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ROCR)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(foreach)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(doParallel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>plots_dir <span class="ot">&lt;-</span> <span class="st">'../plots'</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>models_dir <span class="ot">&lt;-</span> <span class="st">'../models'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>TF <span class="ot">&lt;-</span> <span class="st">'GATA3'</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>cistrome_dir <span class="ot">&lt;-</span> <span class="st">'/projects/covid-ct/imlab/data/cistrome/compressed'</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>hf_info <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="fu">glue</span>(<span class="st">'{cistrome_dir}/human_factor_full_QC.txt'</span>))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>TF_DCID <span class="ot">&lt;-</span> hf_info[hf_info<span class="sc">$</span>Factor <span class="sc">==</span> TF, ]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(TF_DCID)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    DCid      Species     GSMID Factor Cell_line       Cell_type Tissue_type
1:  2324 Homo sapiens GSM720423  GATA3     MCF-7      Epithelium      Breast
2:  2325 Homo sapiens GSM720422  GATA3     MCF-7      Epithelium      Breast
3:  9195 Homo sapiens GSM957608  GATA3 RPMI-8402 T cell leukemia       Blood
4:  9196 Homo sapiens GSM957609  GATA3 RPMI-8402 T cell leukemia       Blood
5: 33129 Homo sapiens GSM986070  GATA3     MCF-7      Epithelium      Breast
6: 33136 Homo sapiens GSM986075  GATA3     MCF-7      Epithelium      Breast
   FastQC UniquelyMappedRatio   PBC PeaksFoldChangeAbove10       FRiP
1:     30              0.7981 0.980                   5420 0.03490225
2:     30              0.8010 0.989                  12454 0.08374850
3:     39              0.7523 0.244                   1432 0.08693400
4:     39              0.7604 0.808                   3459 0.04521850
5:     39              0.8001 0.990                   8318 0.04329025
6:     39              0.7460 0.971                    358 0.00357925
   PeaksUnionDHSRatio
1:          0.9750000
2:          0.9810000
3:          0.8848000
4:          0.9524000
5:          0.9618000
6:          0.8949343</code></pre>
</div>
</div>
<p>https://stats.stackexchange.com/questions/138569/why-is-lambda-within-one-standard-error-from-the-minimum-is-a-recommended-valu</p>
<div style="page-break-after: always;"></div>
<p>For plotting, I need to load in the enformer annotations</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>enformer_annotations <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="st">'../info-files/enformer_tracks_annotated-resaved.txt'</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>enformer_annotations <span class="ot">&lt;-</span> enformer_annotations[<span class="sc">!</span><span class="fu">is.na</span>(enformer_annotations<span class="sc">$</span>assay), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># using an individual for now &gt;&gt; will do this across all 3 individuals later</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ind <span class="ot">&lt;-</span> <span class="st">'HG00479'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are 5 major categories</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>assays <span class="ot">&lt;-</span> enformer_annotations<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">unique</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>assays</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "DNase-seq"        "ATAC-seq"         "TF ChIP-seq"      "Histone ChIP-seq"
[5] "CAGE experiment" </code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>z_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(assays)){</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    z <span class="ot">&lt;-</span> <span class="fu">combn</span>(assays, i)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    z_list[[i]] <span class="ot">&lt;-</span> <span class="fu">t</span>(z) <span class="sc">|&gt;</span> <span class="fu">as.data.frame</span>()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>assays_dt <span class="ot">&lt;-</span> plyr<span class="sc">::</span><span class="fu">rbind.fill</span>(z_list)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># registerDoMC(cores = 24)</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># enet_models_aggByMean &lt;- list()</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co"># # pick the tracks</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># for(i in 1:nrow(assays_dt)){</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">#     cat('Currently on', i, '\n')</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#     # select the categories</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a><span class="co">#     track_categories &lt;- assays_dt[i, ][!is.na(assays_dt[i, ])]</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co">#     selected_tracks &lt;- enformer_annotations$feature_names[enformer_annotations$assay %in% track_categories]</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co">#     X_train_selected &lt;- X_train[, colnames(X_train) %in% selected_tracks]</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#     X_test_selected &lt;- X_test[, colnames(X_test) %in% selected_tracks]</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="co">#     enet_fit_selected &lt;- cv.glmnet(x=X_train_selected[complete.cases(X_train_selected),], y=y_train[complete.cases(X_train_selected)], family = "binomial", type.measure = "auc", alpha = 0.5, parallel=T, keep=T)</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="co">#     enet_models_aggByMean[[i]] &lt;- enet_fit_selected</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="co"># }</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="helper-functions" class="level3">
<h3 class="anchored" data-anchor-id="helper-functions">helper functions</h3>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>build_save_list_model <span class="ot">&lt;-</span> <span class="cf">function</span>(){</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this function by default uses whatever X_train and y_train is in the environment</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="dv">12</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">registerDoParallel</span>(cl)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">getDoParName</span>())</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    assays_dt <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">'assays_dt'</span>, .GlobalEnv)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    enformer_annotations <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">'enformer_annotations'</span>, .GlobalEnv)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    X_train <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">'X_train'</span>, .GlobalEnv)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    y_train <span class="ot">&lt;-</span> <span class="fu">get</span>(<span class="st">'y_train'</span>, .GlobalEnv)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    enet_models_list <span class="ot">&lt;-</span> <span class="fu">foreach</span>(<span class="at">i =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(assays_dt)) <span class="sc">%dopar%</span> {</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">#cat('Currently on', i, '\n')</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># select the categories</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>        track_categories <span class="ot">&lt;-</span> assays_dt[i, ][<span class="sc">!</span><span class="fu">is.na</span>(assays_dt[i, ])]</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        selected_tracks <span class="ot">&lt;-</span> enformer_annotations<span class="sc">$</span>feature_names[enformer_annotations<span class="sc">$</span>assay <span class="sc">%in%</span> track_categories]</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>        X_train_selected <span class="ot">&lt;-</span> X_train[, <span class="fu">colnames</span>(X_train) <span class="sc">%in%</span> selected_tracks]</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">#X_test_selected &lt;- X_test[, colnames(X_test) %in% selected_tracks]</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>        enet_fit_selected <span class="ot">&lt;-</span> glmnet<span class="sc">::</span><span class="fu">cv.glmnet</span>(<span class="at">x=</span>X_train_selected[<span class="fu">complete.cases</span>(X_train_selected),], <span class="at">y=</span>y_train[<span class="fu">complete.cases</span>(X_train_selected)], <span class="at">family =</span> <span class="st">"binomial"</span>, <span class="at">type.measure =</span> <span class="st">"auc"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>, <span class="at">parallel=</span>T, <span class="at">keep=</span>T)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>        enet_fit_selected</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stopCluster</span>(cl)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(enet_models_list)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>collate_coefficients <span class="ot">&lt;-</span> <span class="cf">function</span>(fit){</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>    min_error_index <span class="ot">&lt;-</span> fit<span class="sc">$</span>index[<span class="st">'min'</span>, ]</span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    one_sd_index <span class="ot">&lt;-</span> fit<span class="sc">$</span>index[<span class="st">'1se'</span>, ]</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>    dimensions <span class="ot">&lt;-</span> fit<span class="sc">$</span>glmnet.fit<span class="sc">$</span>beta<span class="sc">@</span>Dim</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>    coef_mat <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">summary</span>(fit<span class="sc">$</span>glmnet.fit<span class="sc">$</span>beta))</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    temp_mat <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">data=</span><span class="cn">NA</span>, <span class="at">nrow=</span>dimensions[<span class="dv">1</span>], <span class="at">ncol=</span>dimensions[<span class="dv">2</span>])</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(dim(temp_mat))</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(coef_mat)){</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>        temp_mat[coef_mat[i, <span class="st">'i'</span>], coef_mat[i, <span class="st">'j'</span>]] <span class="ot">&lt;-</span> coef_mat[i, <span class="st">'x'</span>]</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    temp_mat[<span class="fu">is.na</span>(temp_mat)] <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    fit_beta <span class="ot">&lt;-</span> <span class="fu">cbind</span>(temp_mat[, min_error_index], temp_mat[, one_sd_index])</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># what features were used?</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    feature_data <span class="ot">&lt;-</span> enformer_annotations[enformer_annotations<span class="sc">$</span>feature_names <span class="sc">%in%</span> (fit<span class="sc">$</span>glmnet.fit<span class="sc">$</span>beta <span class="sc">|&gt;</span> <span class="fu">rownames</span>()), <span class="fu">c</span>(<span class="st">'assay'</span>, <span class="st">'feature_names'</span>)]</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    fit_beta <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">cbind</span>(fit_beta, feature_data))</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(fit_beta)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>test_models <span class="ot">&lt;-</span> <span class="cf">function</span>(model, X_test_set, y_test_set){</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>    features <span class="ot">&lt;-</span> model<span class="sc">$</span>glmnet.fit<span class="sc">$</span>beta <span class="sc">|&gt;</span> <span class="fu">rownames</span>()</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a>    X_test_set <span class="ot">&lt;-</span> X_test_set[, features]</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">assess.glmnet</span>(model, <span class="at">newx =</span> X_test_set, <span class="at">newy =</span> y_test_set) <span class="sc">|&gt;</span> <span class="fu">unlist</span>()</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="models-built-based-on-aggregating-by-the-mean" class="level1">
<h1>Models built based on aggregating by the mean</h1>
<p>Here, each predictor is the average of the 8 bins upstream and downstream the bin where the center of the motif resides.</p>
<p>Loading the data</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/train_aggByMean_{ind}.csv'</span>))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="dv">1</span>])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/test_aggByMean_{ind}.csv'</span>))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">'enet_models_aggByMean.RData'</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check if a list of models exist and load that and no need to run what is below</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))){</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models exists. Reading it in...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMean <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models does not exist. Making one...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMean <span class="ot">&lt;-</span> <span class="fu">build_save_list_model</span>()</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save the model for next time</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(enet_models_aggByMean, <span class="at">file=</span><span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "List of models exists. Reading it in...\n"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>fit_beta_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'For lambda with minimum mean cv error'</span>, <span class="st">'For largest lambda with 1 s.e within the mininum error'</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="co">#fit &lt;- enet_models_aggByMean[[1]]</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>df_beta_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMean, collate_coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performance on the test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMean, test_models, X_test, y_test)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> out[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>performance_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      deviance.lambda.1se class.lambda.1se      auc mse.lambda.1se
 [1,]           0.8156511            0.167 0.896096      0.2530849
 [2,]           0.8166219            0.168 0.895824      0.2535387
 [3,]           0.8288001            0.172 0.892656      0.2584556
 [4,]           0.8311036            0.168 0.892024      0.2592487
 [5,]           0.8332811            0.169 0.891284      0.2600438
 [6,]           0.8327018            0.180 0.891304      0.2624693
 [7,]           0.8457169            0.177 0.888700      0.2648518
 [8,]           0.8466081            0.179 0.889016      0.2651929
 [9,]           0.8465984            0.180 0.888960      0.2652060
[10,]           0.8390017            0.179 0.889684      0.2652883
[11,]           0.8494422            0.185 0.887072      0.2680351
[12,]           0.8478419            0.181 0.887172      0.2682264
[13,]           0.8509680            0.180 0.886524      0.2692344
[14,]           0.8521493            0.183 0.886372      0.2692656
[15,]           0.8566715            0.183 0.884896      0.2708323
[16,]           0.8690709            0.181 0.882948      0.2749215
[17,]           0.9324916            0.204 0.861420      0.2988393
[18,]           0.9472972            0.203 0.857272      0.3042444
[19,]           0.9477681            0.203 0.856416      0.3043503
[20,]           0.9467487            0.205 0.857444      0.3053236
[21,]           1.1319486            0.199 0.849324      0.3069142
[22,]           0.9543058            0.208 0.853940      0.3085327
[23,]           0.9567384            0.203 0.853368      0.3093878
[24,]           1.0486718            0.204 0.855116      0.3096510
[25,]           0.9577200            0.203 0.852148      0.3097454
[26,]           0.9602302            0.204 0.851808      0.3102784
[27,]           1.1649470            0.197 0.845872      0.3114010
[28,]           1.0824841            0.205 0.841604      0.3254376
[29,]           1.2687015            0.222 0.823754      0.3418565
[30,]           1.3538468            0.219 0.823088      0.3523360
[31,]           1.2126353            0.340 0.734760      0.4175183
      mae.lambda.1se
 [1,]      0.5152429
 [2,]      0.5184651
 [3,]      0.5356986
 [4,]      0.5395491
 [5,]      0.5405884
 [6,]      0.5192550
 [7,]      0.5584434
 [8,]      0.5618479
 [9,]      0.5618107
[10,]      0.5336142
[11,]      0.5488024
[12,]      0.5488022
[13,]      0.5526803
[14,]      0.5505997
[15,]      0.5548318
[16,]      0.5757830
[17,]      0.6086663
[18,]      0.6227516
[19,]      0.6194255
[20,]      0.6310915
[21,]      0.5813512
[22,]      0.6280597
[23,]      0.6321777
[24,]      0.6304751
[25,]      0.6222828
[26,]      0.6266728
[27,]      0.5976159
[28,]      0.6733183
[29,]      0.6575721
[30,]      0.6924181
[31,]      0.8414779</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>assays_dt[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 V1               V2               V3               V4
13      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
22         ATAC-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
19        DNase-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
30         ATAC-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
25      TF ChIP-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
20        DNase-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
29        DNase-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
31        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
26        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
7         DNase-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
10         ATAC-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
16        DNase-seq         ATAC-seq      TF ChIP-seq             &lt;NA&gt;
27        DNase-seq         ATAC-seq      TF ChIP-seq  CAGE experiment
3       TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
14      TF ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
23         ATAC-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
28        DNase-seq         ATAC-seq Histone ChIP-seq  CAGE experiment
8         DNase-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
21        DNase-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
17        DNase-seq         ATAC-seq Histone ChIP-seq             &lt;NA&gt;
18        DNase-seq         ATAC-seq  CAGE experiment             &lt;NA&gt;
24         ATAC-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
11         ATAC-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
6         DNase-seq         ATAC-seq             &lt;NA&gt;             &lt;NA&gt;
15 Histone ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
4  Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
9         DNase-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
1         DNase-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
12         ATAC-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
5   CAGE experiment             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
2          ATAC-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
                V5
13            &lt;NA&gt;
22            &lt;NA&gt;
19            &lt;NA&gt;
30            &lt;NA&gt;
25            &lt;NA&gt;
20            &lt;NA&gt;
29            &lt;NA&gt;
31 CAGE experiment
26            &lt;NA&gt;
7             &lt;NA&gt;
10            &lt;NA&gt;
16            &lt;NA&gt;
27            &lt;NA&gt;
3             &lt;NA&gt;
14            &lt;NA&gt;
23            &lt;NA&gt;
28            &lt;NA&gt;
8             &lt;NA&gt;
21            &lt;NA&gt;
17            &lt;NA&gt;
18            &lt;NA&gt;
24            &lt;NA&gt;
11            &lt;NA&gt;
6             &lt;NA&gt;
15            &lt;NA&gt;
4             &lt;NA&gt;
9             &lt;NA&gt;
1             &lt;NA&gt;
12            &lt;NA&gt;
5             &lt;NA&gt;
2             &lt;NA&gt;</code></pre>
</div>
</div>
<p>The best model based on the lowest mse</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>bmodel_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(out[, <span class="dv">4</span>])</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>bmodel <span class="ot">&lt;-</span> enet_models_aggByMean[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some diagnostic plots</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> assays_dt[bmodel_index, ]</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> <span class="fu">paste0</span>(used_categories[<span class="sc">!</span><span class="fu">is.na</span>(used_categories)], <span class="at">collapse=</span><span class="st">' + '</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">2.0</span>, <span class="dv">3</span>, <span class="fl">2.0</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>bmodel <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMean: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta <span class="ot">&lt;-</span> df_beta_list[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>useColors <span class="ot">&lt;-</span> RColorBrewer<span class="sc">::</span><span class="fu">brewer.pal</span>(<span class="at">n=</span><span class="dv">8</span>, <span class="at">name=</span><span class="st">'Dark2'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>df_beta_labels <span class="ot">&lt;-</span> fit_beta_labels</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta_split <span class="ot">&lt;-</span> <span class="fu">split</span>(bmodel_df_beta, bmodel_df_beta<span class="sc">$</span>assay)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="co"># define the layout</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T), <span class="at">height=</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="at">width=</span><span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>))</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">2.5</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>, <span class="at">oma=</span><span class="fu">c</span>(<span class="fl">3.5</span>, <span class="fl">2.0</span>, <span class="fl">3.5</span>, <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    ylimits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bmodel_df_beta[, i]), <span class="fu">max</span>(bmodel_df_beta[, i]))</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(ylimits)</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">x=</span>bmodel_df_beta_split[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[<span class="dv">1</span>]][, i], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span>useColors[<span class="dv">1</span>], <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)), <span class="at">ylim=</span>ylimits, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">main=</span>df_beta_labels[i])</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)){</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="at">x=</span>bmodel_df_beta_split[[j]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[j]][, i], <span class="at">col=</span>useColors[j])</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mtext('TTTT', side=1, outer=T, cex=1.2)</span></span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)))</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'tracks'</span>, <span class="at">side=</span><span class="dv">1</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'coefficients'</span>, <span class="at">side=</span><span class="dv">2</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMean: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.3</span>, <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'right'</span>, <span class="at">legend=</span><span class="fu">names</span>(bmodel_df_beta_split), <span class="at">col=</span>useColors[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)], <span class="at">lty=</span><span class="dv">1</span>, <span class="at">bty=</span><span class="st">'n'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<div style="page-break-after: always;"></div>
<section id="using-the-bin-where-the-center-of-the-motif-resides" class="level2">
<h2 class="anchored" data-anchor-id="using-the-bin-where-the-center-of-the-motif-resides">Using the bin where the center of the motif resides</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/train_aggByCenter_{ind}.csv'</span>))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="dv">1</span>])</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/test_aggByCenter_{ind}.csv'</span>))</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">'enet_models_aggByCenter.RData'</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check if a list of models exist and load that and no need to run what is below</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))){</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models exists. Reading it in...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByCenter <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models does not exist. Making one...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByCenter <span class="ot">&lt;-</span> <span class="fu">build_save_list_model</span>()</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save the model for next time</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(enet_models_aggByCenter, <span class="at">file=</span><span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "List of models exists. Reading it in...\n"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>fit_beta_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'For lambda with minimum mean cv error'</span>, <span class="st">'For largest lambda with 1 s.e within the mininum error'</span>)</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>df_beta_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByCenter, collate_coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performance on the test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByCenter, test_models, X_test, y_test)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> out[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>performance_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      deviance.lambda.1se class.lambda.1se      auc mse.lambda.1se
 [1,]           0.8615837            0.170 0.892356      0.2597969
 [2,]           0.8576432            0.168 0.893024      0.2604146
 [3,]           0.8663149            0.172 0.890600      0.2610155
 [4,]           0.8580691            0.169 0.892796      0.2611090
 [5,]           0.8608391            0.170 0.891904      0.2616458
 [6,]           0.8608554            0.171 0.891836      0.2622080
 [7,]           0.8608988            0.170 0.892340      0.2630260
 [8,]           0.8624001            0.170 0.891912      0.2636486
 [9,]           0.8772511            0.179 0.886104      0.2653698
[10,]           0.8766057            0.183 0.886568      0.2657593
[11,]           0.8806980            0.183 0.886820      0.2680398
[12,]           0.8814737            0.188 0.886672      0.2702012
[13,]           0.8863099            0.189 0.885480      0.2714958
[14,]           0.8865424            0.187 0.885424      0.2720126
[15,]           0.8898947            0.189 0.884320      0.2722184
[16,]           0.8916698            0.190 0.883380      0.2756564
[17,]           1.1475980            0.201 0.849128      0.3118593
[18,]           1.1202401            0.200 0.849452      0.3120041
[19,]           0.9661149            0.214 0.849516      0.3124643
[20,]           0.9679619            0.209 0.848708      0.3131533
[21,]           0.9739954            0.211 0.847516      0.3146059
[22,]           0.9752082            0.211 0.846796      0.3151862
[23,]           0.9751655            0.207 0.846340      0.3157301
[24,]           0.9732397            0.213 0.846172      0.3163409
[25,]           0.9760579            0.214 0.845180      0.3170445
[26,]           0.9813004            0.214 0.844008      0.3183115
[27,]           1.2067343            0.204 0.841900      0.3186592
[28,]           1.1139677            0.200 0.841528      0.3206637
[29,]           1.3373696            0.237 0.824212      0.3449781
[30,]           1.2799677            0.249 0.816470      0.3499790
[31,]           1.2561187            0.340 0.716000      0.4313464
      mae.lambda.1se
 [1,]      0.5454180
 [2,]      0.5548256
 [3,]      0.5435983
 [4,]      0.5585875
 [5,]      0.5563141
 [6,]      0.5600045
 [7,]      0.5667661
 [8,]      0.5678039
 [9,]      0.5261006
[10,]      0.5422272
[11,]      0.5556400
[12,]      0.5691070
[13,]      0.5677313
[14,]      0.5711500
[15,]      0.5621169
[16,]      0.5863250
[17,]      0.5934016
[18,]      0.6132451
[19,]      0.6226593
[20,]      0.6276327
[21,]      0.6304141
[22,]      0.6355271
[23,]      0.6311741
[24,]      0.6379632
[25,]      0.6396655
[26,]      0.6404754
[27,]      0.5920757
[28,]      0.6367542
[29,]      0.6610192
[30,]      0.6661281
[31,]      0.8641689</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>assays_dt[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 V1               V2               V3               V4
31        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
25      TF ChIP-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
19        DNase-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
30         ATAC-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
13      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
22         ATAC-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
29        DNase-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
26        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
23         ATAC-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
3       TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
10         ATAC-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
14      TF ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
7         DNase-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
16        DNase-seq         ATAC-seq      TF ChIP-seq             &lt;NA&gt;
20        DNase-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
27        DNase-seq         ATAC-seq      TF ChIP-seq  CAGE experiment
18        DNase-seq         ATAC-seq  CAGE experiment             &lt;NA&gt;
6         DNase-seq         ATAC-seq             &lt;NA&gt;             &lt;NA&gt;
4  Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
11         ATAC-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
15 Histone ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
24         ATAC-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
28        DNase-seq         ATAC-seq Histone ChIP-seq  CAGE experiment
17        DNase-seq         ATAC-seq Histone ChIP-seq             &lt;NA&gt;
8         DNase-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
21        DNase-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
9         DNase-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
1         DNase-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
5   CAGE experiment             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
12         ATAC-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
2          ATAC-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
                V5
31 CAGE experiment
25            &lt;NA&gt;
19            &lt;NA&gt;
30            &lt;NA&gt;
13            &lt;NA&gt;
22            &lt;NA&gt;
29            &lt;NA&gt;
26            &lt;NA&gt;
23            &lt;NA&gt;
3             &lt;NA&gt;
10            &lt;NA&gt;
14            &lt;NA&gt;
7             &lt;NA&gt;
16            &lt;NA&gt;
20            &lt;NA&gt;
27            &lt;NA&gt;
18            &lt;NA&gt;
6             &lt;NA&gt;
4             &lt;NA&gt;
11            &lt;NA&gt;
15            &lt;NA&gt;
24            &lt;NA&gt;
28            &lt;NA&gt;
17            &lt;NA&gt;
8             &lt;NA&gt;
21            &lt;NA&gt;
9             &lt;NA&gt;
1             &lt;NA&gt;
5             &lt;NA&gt;
12            &lt;NA&gt;
2             &lt;NA&gt;</code></pre>
</div>
</div>
<p>The best model based on the lowest mse</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>bmodel_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(out[, <span class="dv">4</span>])</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>bmodel <span class="ot">&lt;-</span> enet_models_aggByCenter[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some diagnostic plots</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> assays_dt[bmodel_index, ]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> <span class="fu">paste0</span>(used_categories[<span class="sc">!</span><span class="fu">is.na</span>(used_categories)], <span class="at">collapse=</span><span class="st">' + '</span>)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">2.0</span>, <span class="dv">3</span>, <span class="fl">2.0</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>bmodel <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByCenter: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta <span class="ot">&lt;-</span> df_beta_list[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta_split <span class="ot">&lt;-</span> <span class="fu">split</span>(bmodel_df_beta, bmodel_df_beta<span class="sc">$</span>assay)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define the layout</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T), <span class="at">height=</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="at">width=</span><span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>))</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">2.5</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>, <span class="at">oma=</span><span class="fu">c</span>(<span class="fl">3.5</span>, <span class="fl">2.0</span>, <span class="fl">3.5</span>, <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    ylimits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bmodel_df_beta[, i]), <span class="fu">max</span>(bmodel_df_beta[, i]))</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(ylimits)</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">x=</span>bmodel_df_beta_split[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[<span class="dv">1</span>]][, i], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span>useColors[<span class="dv">1</span>], <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)), <span class="at">ylim=</span>ylimits, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">main=</span>df_beta_labels[i])</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)){</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="at">x=</span>bmodel_df_beta_split[[j]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[j]][, i], <span class="at">col=</span>useColors[j])</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mtext('TTTT', side=1, outer=T, cex=1.2)</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)))</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'tracks'</span>, <span class="at">side=</span><span class="dv">1</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'coefficients'</span>, <span class="at">side=</span><span class="dv">2</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByCenter: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.3</span>, <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'right'</span>, <span class="at">legend=</span><span class="fu">names</span>(bmodel_df_beta_split), <span class="at">col=</span>useColors[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)], <span class="at">lty=</span><span class="dv">1</span>, <span class="at">bty=</span><span class="st">'n'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-31-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>How many of those features had non-zero coefficients by group?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>greek_lambda <span class="ot">&lt;-</span> <span class="st">'\U03BB'</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>V1 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>V2 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>V_merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(V1, V2, <span class="at">by=</span><span class="st">'Var1'</span>, <span class="at">all=</span>T)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(V_merged) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'category'</span>, <span class="fu">paste</span>(greek_lambda, <span class="st">'-min'</span>, <span class="at">sep=</span><span class="st">''</span>), <span class="fu">paste</span>(greek_lambda, <span class="st">'-1se'</span>, <span class="at">sep=</span><span class="st">''</span>))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>V_merged    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          category λ-min λ-1se
1         ATAC-seq     1    NA
2  CAGE experiment     9     4
3        DNase-seq    31    18
4 Histone ChIP-seq   151    86
5      TF ChIP-seq   157   119</code></pre>
</div>
</div>
<p>How many non-zero coefficients between both?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta[(bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>), ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
 CAGE experiment        DNase-seq Histone ChIP-seq      TF ChIP-seq 
               3               15               81              105 </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="using-only-the-upstream-bins" class="level2">
<h2 class="anchored" data-anchor-id="using-only-the-upstream-bins">Using only the upstream bins</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/train_aggByMeanUpstream_{ind}.csv'</span>))</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="dv">1</span>])</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/test_aggByMeanUpstream_{ind}.csv'</span>))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">'enet_models_aggByMeanUpstream.RData'</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check if a list of models exist and load that and no need to run what is below</span></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))){</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models exists. Reading it in...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMeanUpstream <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models does not exist. Making one...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMeanUpstream <span class="ot">&lt;-</span> <span class="fu">build_save_list_model</span>()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save the model for next time</span></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(enet_models_aggByMeanUpstream, <span class="at">file=</span><span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "List of models exists. Reading it in...\n"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>fit_beta_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'For lambda with minimum mean cv error'</span>, <span class="st">'For largest lambda with 1 s.e within the mininum error'</span>)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>df_beta_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMeanUpstream, collate_coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performance on the test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMeanUpstream, test_models, X_test, y_test)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> out[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>performance_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      deviance.lambda.1se class.lambda.1se      auc mse.lambda.1se
 [1,]           0.6113700           0.1190 0.950053      0.1821517
 [2,]           0.6178001           0.1195 0.948845      0.1840680
 [3,]           0.6573991           0.1290 0.941239      0.1976988
 [4,]           0.6693576           0.1280 0.939018      0.2014307
 [5,]           0.6738551           0.1350 0.935409      0.2044063
 [6,]           0.6780805           0.1290 0.937282      0.2045199
 [7,]           0.6762147           0.1380 0.934587      0.2052842
 [8,]           0.6829223           0.1290 0.936435      0.2059163
 [9,]           0.6862911           0.1335 0.935621      0.2073949
[10,]           0.6934735           0.1395 0.931403      0.2110823
[11,]           0.6988699           0.1400 0.930487      0.2129385
[12,]           0.7185956           0.1455 0.926371      0.2195414
[13,]           0.7053996           0.1490 0.934784      0.2195482
[14,]           0.7337998           0.1395 0.926742      0.2232569
[15,]           0.7369971           0.1490 0.928292      0.2246117
[16,]           0.7432182           0.1495 0.921170      0.2279994
[17,]           0.7433774           0.1525 0.921295      0.2280871
[18,]           0.7479954           0.1520 0.925931      0.2285603
[19,]           0.7494207           0.1545 0.925473      0.2290803
[20,]           0.7562133           0.1570 0.919089      0.2360201
[21,]           0.7558817           0.1415 0.930740      0.2363107
[22,]           0.7788578           0.1585 0.919535      0.2395381
[23,]           0.7787423           0.1600 0.918805      0.2398062
[24,]           0.7723964           0.1510 0.919298      0.2411223
[25,]           0.7869658           0.1655 0.916383      0.2429989
[26,]           0.7908735           0.1615 0.915794      0.2441780
[27,]           0.7907424           0.1630 0.916026      0.2442133
[28,]           0.7893754           0.1610 0.915812      0.2467911
[29,]           0.8047251           0.1580 0.909065      0.2494848
[30,]           0.8432756           0.1735 0.902135      0.2669377
[31,]           1.2096616           0.3330 0.732913      0.4182275
      mae.lambda.1se
 [1,]      0.4325133
 [2,]      0.4373782
 [3,]      0.4659782
 [4,]      0.4755307
 [5,]      0.4670024
 [6,]      0.4818230
 [7,]      0.4685612
 [8,]      0.4860064
 [9,]      0.4880592
[10,]      0.4831119
[11,]      0.4871100
[12,]      0.5036127
[13,]      0.5143937
[14,]      0.5266165
[15,]      0.5334084
[16,]      0.5234905
[17,]      0.5234586
[18,]      0.5416630
[19,]      0.5425592
[20,]      0.5380247
[21,]      0.5585082
[22,]      0.5652534
[23,]      0.5636250
[24,]      0.5594441
[25,]      0.5687119
[26,]      0.5718974
[27,]      0.5726496
[28,]      0.5741255
[29,]      0.5751123
[30,]      0.6102591
[31,]      0.8503326</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>assays_dt[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 V1               V2               V3               V4
30         ATAC-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
19        DNase-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
22         ATAC-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
26        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
10         ATAC-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
25      TF ChIP-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
3       TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
31        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
13      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
7         DNase-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
23         ATAC-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
27        DNase-seq         ATAC-seq      TF ChIP-seq  CAGE experiment
12         ATAC-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
29        DNase-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
17        DNase-seq         ATAC-seq Histone ChIP-seq             &lt;NA&gt;
20        DNase-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
16        DNase-seq         ATAC-seq      TF ChIP-seq             &lt;NA&gt;
21        DNase-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
8         DNase-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
1         DNase-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
5   CAGE experiment             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
28        DNase-seq         ATAC-seq Histone ChIP-seq  CAGE experiment
24         ATAC-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
18        DNase-seq         ATAC-seq  CAGE experiment             &lt;NA&gt;
4  Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
11         ATAC-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
15 Histone ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
9         DNase-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
14      TF ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
6         DNase-seq         ATAC-seq             &lt;NA&gt;             &lt;NA&gt;
2          ATAC-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
                V5
30            &lt;NA&gt;
19            &lt;NA&gt;
22            &lt;NA&gt;
26            &lt;NA&gt;
10            &lt;NA&gt;
25            &lt;NA&gt;
3             &lt;NA&gt;
31 CAGE experiment
13            &lt;NA&gt;
7             &lt;NA&gt;
23            &lt;NA&gt;
27            &lt;NA&gt;
12            &lt;NA&gt;
29            &lt;NA&gt;
17            &lt;NA&gt;
20            &lt;NA&gt;
16            &lt;NA&gt;
21            &lt;NA&gt;
8             &lt;NA&gt;
1             &lt;NA&gt;
5             &lt;NA&gt;
28            &lt;NA&gt;
24            &lt;NA&gt;
18            &lt;NA&gt;
4             &lt;NA&gt;
11            &lt;NA&gt;
15            &lt;NA&gt;
9             &lt;NA&gt;
14            &lt;NA&gt;
6             &lt;NA&gt;
2             &lt;NA&gt;</code></pre>
</div>
</div>
<p>The best model based on the lowest mse</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>bmodel_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(out[, <span class="dv">4</span>])</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>bmodel <span class="ot">&lt;-</span> enet_models_aggByMeanUpstream[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some diagnostic plots</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> assays_dt[bmodel_index, ]</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> <span class="fu">paste0</span>(used_categories[<span class="sc">!</span><span class="fu">is.na</span>(used_categories)], <span class="at">collapse=</span><span class="st">' + '</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">2.0</span>, <span class="dv">3</span>, <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>bmodel <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMeanUpstream: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-41-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta <span class="ot">&lt;-</span> df_beta_list[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta_split <span class="ot">&lt;-</span> <span class="fu">split</span>(bmodel_df_beta, bmodel_df_beta<span class="sc">$</span>assay)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define the layout</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T), <span class="at">height=</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="at">width=</span><span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>))</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">2.5</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>, <span class="at">oma=</span><span class="fu">c</span>(<span class="fl">3.5</span>, <span class="fl">2.0</span>, <span class="fl">3.5</span>, <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>    ylimits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bmodel_df_beta[, i]), <span class="fu">max</span>(bmodel_df_beta[, i]))</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(ylimits)</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">x=</span>bmodel_df_beta_split[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[<span class="dv">1</span>]][, i], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span>useColors[<span class="dv">1</span>], <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)), <span class="at">ylim=</span>ylimits, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">main=</span>df_beta_labels[i])</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)){</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="at">x=</span>bmodel_df_beta_split[[j]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[j]][, i], <span class="at">col=</span>useColors[j])</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mtext('TTTT', side=1, outer=T, cex=1.2)</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)))</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'tracks'</span>, <span class="at">side=</span><span class="dv">1</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'coefficients'</span>, <span class="at">side=</span><span class="dv">2</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>)</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMeanUpstream: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.3</span>, <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'right'</span>, <span class="at">legend=</span><span class="fu">names</span>(bmodel_df_beta_split), <span class="at">col=</span>useColors[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)], <span class="at">lty=</span><span class="dv">1</span>, <span class="at">bty=</span><span class="st">'n'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-43-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>How many of those features had non-zero coefficients by group?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>greek_lambda <span class="ot">&lt;-</span> <span class="st">'\U03BB'</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>V1 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>V2 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>V_merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(V1, V2, <span class="at">by=</span><span class="st">'Var1'</span>, <span class="at">all=</span>T)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(V_merged) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'category'</span>, <span class="fu">paste</span>(greek_lambda, <span class="st">'-min'</span>, <span class="at">sep=</span><span class="st">''</span>), <span class="fu">paste</span>(greek_lambda, <span class="st">'-1se'</span>, <span class="at">sep=</span><span class="st">''</span>))</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>V_merged    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          category λ-min λ-1se
1         ATAC-seq     2     2
2  CAGE experiment     9     6
3 Histone ChIP-seq   187   126
4      TF ChIP-seq   163   130</code></pre>
</div>
</div>
<p>How many non-zero coefficients between both?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta[(bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>), ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        ATAC-seq  CAGE experiment Histone ChIP-seq      TF ChIP-seq 
               2                5              119              116 </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="using-only-the-downstream-bins" class="level2">
<h2 class="anchored" data-anchor-id="using-only-the-downstream-bins">Using only the downstream bins</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/train_aggByMeanDownstream_{ind}.csv'</span>))</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="dv">1</span>])</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/test_aggByMeanDownstream_{ind}.csv'</span>))</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">'enet_models_aggByMeanDownstream.RData'</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check if a list of models exist and load that and no need to run what is below</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))){</span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models exists. Reading it in...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMeanDownstream <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models does not exist. Making one...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMeanDownstream <span class="ot">&lt;-</span> <span class="fu">build_save_list_model</span>()</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save the model for next time</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(enet_models_aggByMeanDownstream, <span class="at">file=</span><span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "List of models exists. Reading it in...\n"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>fit_beta_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'For lambda with minimum mean cv error'</span>, <span class="st">'For largest lambda with 1 s.e within the mininum error'</span>)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>df_beta_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMeanDownstream, collate_coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performance on the test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMeanDownstream, test_models, X_test, y_test)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> out[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>performance_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      deviance.lambda.1se class.lambda.1se      auc mse.lambda.1se
 [1,]           0.6645528           0.1325 0.938558      0.1994726
 [2,]           0.6776925           0.1360 0.936192      0.2038629
 [3,]           0.6772766           0.1355 0.935912      0.2039832
 [4,]           0.6984350           0.1425 0.931889      0.2111586
 [5,]           0.6983271           0.1410 0.931275      0.2114537
 [6,]           0.7153325           0.1410 0.931290      0.2157097
 [7,]           0.7147369           0.1440 0.928558      0.2168879
 [8,]           0.7250830           0.1425 0.931253      0.2201138
 [9,]           0.7297943           0.1455 0.928757      0.2207391
[10,]           0.7269555           0.1455 0.930859      0.2209070
[11,]           0.7308117           0.1445 0.928439      0.2211952
[12,]           0.7366647           0.1460 0.927638      0.2231485
[13,]           0.7368817           0.1470 0.928486      0.2242656
[14,]           0.7445302           0.1465 0.926126      0.2259511
[15,]           0.7451422           0.1465 0.925883      0.2261896
[16,]           0.7530653           0.1485 0.924391      0.2290421
[17,]           0.7507136           0.1370 0.934636      0.2330198
[18,]           0.7610707           0.1560 0.919426      0.2333482
[19,]           0.7630241           0.1520 0.921343      0.2342210
[20,]           0.7679869           0.1545 0.920660      0.2361189
[21,]           0.7766457           0.1505 0.919884      0.2374624
[22,]           0.7797693           0.1615 0.915854      0.2400773
[23,]           0.7842454           0.1560 0.918874      0.2409889
[24,]           0.8060816           0.1605 0.912703      0.2497666
[25,]           0.8170086           0.1635 0.909993      0.2536486
[26,]           0.8241892           0.1735 0.906169      0.2621224
[27,]           0.8568156           0.1760 0.899223      0.2700039
[28,]           0.8571608           0.1795 0.896866      0.2721826
[29,]           0.8657064           0.1790 0.896190      0.2748103
[30,]           0.9545624           0.1935 0.877882      0.3070541
[31,]           1.2310914           0.3550 0.711091      0.4287266
      mae.lambda.1se
 [1,]      0.4581010
 [2,]      0.4684239
 [3,]      0.4673184
 [4,]      0.4851183
 [5,]      0.4839362
 [6,]      0.5103986
 [7,]      0.4986449
 [8,]      0.5247044
 [9,]      0.5221092
[10,]      0.5258722
[11,]      0.5226148
[12,]      0.5278577
[13,]      0.5331120
[14,]      0.5340999
[15,]      0.5343658
[16,]      0.5406733
[17,]      0.5549961
[18,]      0.5373929
[19,]      0.5501186
[20,]      0.5541690
[21,]      0.5597159
[22,]      0.5532036
[23,]      0.5702378
[24,]      0.5842990
[25,]      0.5926496
[26,]      0.5943756
[27,]      0.6197079
[28,]      0.6173681
[29,]      0.6271887
[30,]      0.6978003
[31,]      0.8731404</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>assays_dt[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 V1               V2               V3               V4
10         ATAC-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
7         DNase-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
3       TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
27        DNase-seq         ATAC-seq      TF ChIP-seq  CAGE experiment
23         ATAC-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
30         ATAC-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
20        DNase-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
28        DNase-seq         ATAC-seq Histone ChIP-seq  CAGE experiment
19        DNase-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
17        DNase-seq         ATAC-seq Histone ChIP-seq             &lt;NA&gt;
22         ATAC-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
31        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
8         DNase-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
29        DNase-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
26        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
25      TF ChIP-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
5   CAGE experiment             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
16        DNase-seq         ATAC-seq      TF ChIP-seq             &lt;NA&gt;
4  Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
11         ATAC-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
13      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
14      TF ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
21        DNase-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
24         ATAC-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
15 Histone ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
12         ATAC-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
9         DNase-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
6         DNase-seq         ATAC-seq             &lt;NA&gt;             &lt;NA&gt;
18        DNase-seq         ATAC-seq  CAGE experiment             &lt;NA&gt;
1         DNase-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
2          ATAC-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
                V5
10            &lt;NA&gt;
7             &lt;NA&gt;
3             &lt;NA&gt;
27            &lt;NA&gt;
23            &lt;NA&gt;
30            &lt;NA&gt;
20            &lt;NA&gt;
28            &lt;NA&gt;
19            &lt;NA&gt;
17            &lt;NA&gt;
22            &lt;NA&gt;
31 CAGE experiment
8             &lt;NA&gt;
29            &lt;NA&gt;
26            &lt;NA&gt;
25            &lt;NA&gt;
5             &lt;NA&gt;
16            &lt;NA&gt;
4             &lt;NA&gt;
11            &lt;NA&gt;
13            &lt;NA&gt;
14            &lt;NA&gt;
21            &lt;NA&gt;
24            &lt;NA&gt;
15            &lt;NA&gt;
12            &lt;NA&gt;
9             &lt;NA&gt;
6             &lt;NA&gt;
18            &lt;NA&gt;
1             &lt;NA&gt;
2             &lt;NA&gt;</code></pre>
</div>
</div>
<p>The best model based on the lowest mse</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>bmodel_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(out[, <span class="dv">4</span>])</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>bmodel <span class="ot">&lt;-</span> enet_models_aggByMeanDownstream[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some diagnostic plots</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> assays_dt[bmodel_index, ]</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> <span class="fu">paste0</span>(used_categories[<span class="sc">!</span><span class="fu">is.na</span>(used_categories)], <span class="at">collapse=</span><span class="st">' + '</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">2.0</span>, <span class="dv">3</span>, <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>bmodel <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMeanDownstream: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-53-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta <span class="ot">&lt;-</span> df_beta_list[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta_split <span class="ot">&lt;-</span> <span class="fu">split</span>(bmodel_df_beta, bmodel_df_beta<span class="sc">$</span>assay)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define the layout</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T), <span class="at">height=</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="at">width=</span><span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>))</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">2.5</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>, <span class="at">oma=</span><span class="fu">c</span>(<span class="fl">3.5</span>, <span class="fl">2.0</span>, <span class="fl">3.5</span>, <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    ylimits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bmodel_df_beta[, i]), <span class="fu">max</span>(bmodel_df_beta[, i]))</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(ylimits)</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">x=</span>bmodel_df_beta_split[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[<span class="dv">1</span>]][, i], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span>useColors[<span class="dv">1</span>], <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)), <span class="at">ylim=</span>ylimits, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">main=</span>df_beta_labels[i])</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)){</span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="at">x=</span>bmodel_df_beta_split[[j]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[j]][, i], <span class="at">col=</span>useColors[j])</span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mtext('TTTT', side=1, outer=T, cex=1.2)</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)))</span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'tracks'</span>, <span class="at">side=</span><span class="dv">1</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'coefficients'</span>, <span class="at">side=</span><span class="dv">2</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>)</span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMeanDownstream: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.3</span>, <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'right'</span>, <span class="at">legend=</span><span class="fu">names</span>(bmodel_df_beta_split), <span class="at">col=</span>useColors[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)], <span class="at">lty=</span><span class="dv">1</span>, <span class="at">bty=</span><span class="st">'n'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-55-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>How many of those features had non-zero coefficients by group?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>greek_lambda <span class="ot">&lt;-</span> <span class="st">'\U03BB'</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>V1 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>V2 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>V_merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(V1, V2, <span class="at">by=</span><span class="st">'Var1'</span>, <span class="at">all=</span>T)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(V_merged) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'category'</span>, <span class="fu">paste</span>(greek_lambda, <span class="st">'-min'</span>, <span class="at">sep=</span><span class="st">''</span>), <span class="fu">paste</span>(greek_lambda, <span class="st">'-1se'</span>, <span class="at">sep=</span><span class="st">''</span>))</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>V_merged    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     category λ-min λ-1se
1    ATAC-seq     4     4
2 TF ChIP-seq   250   203</code></pre>
</div>
</div>
<p>How many non-zero coefficients between both?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta[(bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>), ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
   ATAC-seq TF ChIP-seq 
          4         194 </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
</section>
<section id="using-only-the-upstream-and-downstream-bins" class="level2">
<h2 class="anchored" data-anchor-id="using-only-the-upstream-and-downstream-bins">Using only the upstream and downstream bins</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/train_aggByMeanUpstreamDownstream_{ind}.csv'</span>))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>X_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>y_train <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(train_data[, <span class="dv">1</span>])</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="fu">glue</span>(<span class="st">'/projects/covid-ct/imlab/users/temi/projects/TFXcan/output/train-test-data/train_aggByMeanUpstreamDownstream_{ind}.csv'</span>))</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>X_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="sc">-</span><span class="fu">c</span>(<span class="dv">1</span>)])</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>y_test <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(test_data[, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>model_name <span class="ot">&lt;-</span> <span class="st">'enet_models_aggByMeanUpstreamDownstream.RData'</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="co"># check if a list of models exist and load that and no need to run what is below</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span>(<span class="fu">file.exists</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))){</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models exists. Reading it in...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMeanUpstreamDownstream <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">'List of models does not exist. Making one...</span><span class="sc">\n</span><span class="st">'</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>    enet_models_aggByMeanUpstreamDownstream <span class="ot">&lt;-</span> <span class="fu">build_save_list_model</span>()</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#save the model for next time</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(enet_models_aggByMeanUpstreamDownstream, <span class="at">file=</span><span class="fu">glue</span>(<span class="st">'{models_dir}/{model_name}'</span>))</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "List of models exists. Reading it in...\n"</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>fit_beta_labels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'For lambda with minimum mean cv error'</span>, <span class="st">'For largest lambda with 1 s.e within the mininum error'</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>df_beta_list <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMeanUpstreamDownstream, collate_coefficients)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Performance on the test set</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">lapply</span>(enet_models_aggByMeanUpstreamDownstream, test_models, X_test, y_test)</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">do.call</span>(rbind, out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>performance_metrics <span class="ot">&lt;-</span> out[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>performance_metrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      deviance.lambda.1se class.lambda.1se      auc mse.lambda.1se
 [1,]           0.6102948           0.1210 0.949892      0.1807648
 [2,]           0.6339397           0.1260 0.945761      0.1892598
 [3,]           0.6457479           0.1255 0.943661      0.1931572
 [4,]           0.6620447           0.1305 0.940758      0.1989886
 [5,]           0.6879170           0.1370 0.936430      0.2076695
 [6,]           0.6859583           0.1400 0.933872      0.2083363
 [7,]           0.6941119           0.1390 0.935343      0.2095745
 [8,]           0.6939594           0.1420 0.931764      0.2113716
 [9,]           0.7040490           0.1380 0.934852      0.2129498
[10,]           0.7050121           0.1430 0.933537      0.2141002
[11,]           0.7049098           0.1445 0.930376      0.2150182
[12,]           0.7173474           0.1460 0.930925      0.2177058
[13,]           0.7111582           0.1480 0.930265      0.2193229
[14,]           0.7230093           0.1485 0.926506      0.2212598
[15,]           0.7276800           0.1440 0.928977      0.2218377
[16,]           0.7322543           0.1445 0.929533      0.2225898
[17,]           0.7300829           0.1480 0.929080      0.2226010
[18,]           0.7304180           0.1495 0.925554      0.2235154
[19,]           0.7374114           0.1490 0.927306      0.2246340
[20,]           0.7343717           0.1510 0.924610      0.2252481
[21,]           0.7447356           0.1490 0.927298      0.2271462
[22,]           0.7431481           0.1525 0.922983      0.2279780
[23,]           0.7475989           0.1495 0.926465      0.2282910
[24,]           0.7719385           0.1550 0.918005      0.2380965
[25,]           0.7661231           0.1580 0.921395      0.2401301
[26,]           0.7819855           0.1465 0.929140      0.2437272
[27,]           0.7934647           0.1575 0.914960      0.2453470
[28,]           0.8141231           0.1725 0.906550      0.2577782
[29,]           0.8255319           0.1705 0.905634      0.2610901
[30,]           0.8820274           0.1860 0.893772      0.2798963
[31,]           1.2019451           0.3385 0.735483      0.4157984
      mae.lambda.1se
 [1,]      0.4300246
 [2,]      0.4476764
 [3,]      0.4571065
 [4,]      0.4691028
 [5,]      0.4898875
 [6,]      0.4785907
 [7,]      0.4950041
 [8,]      0.4833329
 [9,]      0.5067368
[10,]      0.5047782
[11,]      0.4935190
[12,]      0.5130583
[13,]      0.5094230
[14,]      0.5084072
[15,]      0.5228946
[16,]      0.5292109
[17,]      0.5252583
[18,]      0.5158274
[19,]      0.5299422
[20,]      0.5179039
[21,]      0.5393394
[22,]      0.5262999
[23,]      0.5409731
[24,]      0.5513045
[25,]      0.5549893
[26,]      0.5775499
[27,]      0.5732714
[28,]      0.5865891
[29,]      0.5977121
[30,]      0.6407519
[31,]      0.8465468</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>assays_dt[<span class="fu">order</span>(out[, <span class="dv">4</span>], <span class="at">decreasing=</span>F), ]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 V1               V2               V3               V4
26        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
13      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
25      TF ChIP-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
22         ATAC-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
30         ATAC-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
27        DNase-seq         ATAC-seq      TF ChIP-seq  CAGE experiment
29        DNase-seq      TF ChIP-seq Histone ChIP-seq  CAGE experiment
3       TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
8         DNase-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
11         ATAC-seq Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
16        DNase-seq         ATAC-seq      TF ChIP-seq             &lt;NA&gt;
19        DNase-seq      TF ChIP-seq Histone ChIP-seq             &lt;NA&gt;
9         DNase-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
14      TF ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
15 Histone ChIP-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
21        DNase-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
24         ATAC-seq Histone ChIP-seq  CAGE experiment             &lt;NA&gt;
20        DNase-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
31        DNase-seq         ATAC-seq      TF ChIP-seq Histone ChIP-seq
10         ATAC-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
28        DNase-seq         ATAC-seq Histone ChIP-seq  CAGE experiment
7         DNase-seq      TF ChIP-seq             &lt;NA&gt;             &lt;NA&gt;
17        DNase-seq         ATAC-seq Histone ChIP-seq             &lt;NA&gt;
23         ATAC-seq      TF ChIP-seq  CAGE experiment             &lt;NA&gt;
12         ATAC-seq  CAGE experiment             &lt;NA&gt;             &lt;NA&gt;
5   CAGE experiment             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
4  Histone ChIP-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
6         DNase-seq         ATAC-seq             &lt;NA&gt;             &lt;NA&gt;
18        DNase-seq         ATAC-seq  CAGE experiment             &lt;NA&gt;
1         DNase-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
2          ATAC-seq             &lt;NA&gt;             &lt;NA&gt;             &lt;NA&gt;
                V5
26            &lt;NA&gt;
13            &lt;NA&gt;
25            &lt;NA&gt;
22            &lt;NA&gt;
30            &lt;NA&gt;
27            &lt;NA&gt;
29            &lt;NA&gt;
3             &lt;NA&gt;
8             &lt;NA&gt;
11            &lt;NA&gt;
16            &lt;NA&gt;
19            &lt;NA&gt;
9             &lt;NA&gt;
14            &lt;NA&gt;
15            &lt;NA&gt;
21            &lt;NA&gt;
24            &lt;NA&gt;
20            &lt;NA&gt;
31 CAGE experiment
10            &lt;NA&gt;
28            &lt;NA&gt;
7             &lt;NA&gt;
17            &lt;NA&gt;
23            &lt;NA&gt;
12            &lt;NA&gt;
5             &lt;NA&gt;
4             &lt;NA&gt;
6             &lt;NA&gt;
18            &lt;NA&gt;
1             &lt;NA&gt;
2             &lt;NA&gt;</code></pre>
</div>
</div>
<p>The best model based on the lowest mse</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>bmodel_index <span class="ot">&lt;-</span> <span class="fu">which.min</span>(out[, <span class="dv">4</span>])</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>bmodel <span class="ot">&lt;-</span> enet_models_aggByMeanUpstreamDownstream[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Some diagnostic plots</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> assays_dt[bmodel_index, ]</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>used_categories <span class="ot">&lt;-</span> <span class="fu">paste0</span>(used_categories[<span class="sc">!</span><span class="fu">is.na</span>(used_categories)], <span class="at">collapse=</span><span class="st">' + '</span>)</span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">oma=</span><span class="fu">c</span>(<span class="fl">2.0</span>, <span class="fl">2.0</span>, <span class="dv">3</span>, <span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>bmodel <span class="sc">|&gt;</span> <span class="fu">plot</span>()</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMeanUpstreamDownstream: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">line=</span><span class="dv">3</span>, <span class="at">cex=</span><span class="fl">1.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-65-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta <span class="ot">&lt;-</span> df_beta_list[[bmodel_index]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta_split <span class="ot">&lt;-</span> <span class="fu">split</span>(bmodel_df_beta, bmodel_df_beta<span class="sc">$</span>assay)</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co"># define the layout</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="fu">layout</span>(<span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>,<span class="dv">2</span>,<span class="dv">3</span>), <span class="at">nrow =</span> <span class="dv">2</span>, <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T), <span class="at">height=</span><span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">5</span>), <span class="at">width=</span><span class="fu">c</span>(<span class="dv">8</span>,<span class="dv">2</span>))</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="fl">0.5</span>,<span class="fl">2.5</span>,<span class="dv">2</span>,<span class="dv">2</span>) <span class="sc">+</span> <span class="fl">0.1</span>, <span class="at">oma=</span><span class="fu">c</span>(<span class="fl">3.5</span>, <span class="fl">2.0</span>, <span class="fl">3.5</span>, <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fl">0.1</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>){</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a>    ylimits <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">min</span>(bmodel_df_beta[, i]), <span class="fu">max</span>(bmodel_df_beta[, i]))</span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(ylimits)</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">plot</span>(<span class="at">x=</span>bmodel_df_beta_split[[<span class="dv">1</span>]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[<span class="dv">1</span>]][, i], <span class="at">type=</span><span class="st">'l'</span>, <span class="at">col=</span>useColors[<span class="dv">1</span>], <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)), <span class="at">ylim=</span>ylimits, <span class="at">xaxt=</span><span class="st">'n'</span>, <span class="at">main=</span>df_beta_labels[i])</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(j <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)){</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines</span>(<span class="at">x=</span>bmodel_df_beta_split[[j]] <span class="sc">|&gt;</span> <span class="fu">row.names</span>() <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(), <span class="at">y=</span>bmodel_df_beta_split[[j]][, i], <span class="at">col=</span>useColors[j])</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">#mtext('TTTT', side=1, outer=T, cex=1.2)</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="fu">seq</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(bmodel_df_beta)))</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'tracks'</span>, <span class="at">side=</span><span class="dv">1</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>, <span class="at">line=</span><span class="dv">2</span>)</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="st">'coefficients'</span>, <span class="at">side=</span><span class="dv">2</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.2</span>)</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a><span class="fu">mtext</span>(<span class="fu">glue</span>(<span class="st">'aggByMeanUpstreamDownstream: {used_categories}'</span>), <span class="at">side=</span><span class="dv">3</span>, <span class="at">outer=</span>T, <span class="at">cex=</span><span class="fl">1.3</span>, <span class="at">adj=</span><span class="dv">0</span>)</span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mai=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>,<span class="dv">0</span>))</span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a><span class="fu">plot.new</span>()</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">'right'</span>, <span class="at">legend=</span><span class="fu">names</span>(bmodel_df_beta_split), <span class="at">col=</span>useColors[<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(bmodel_df_beta_split)], <span class="at">lty=</span><span class="dv">1</span>, <span class="at">bty=</span><span class="st">'n'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="impact-enformer-modelling_files/figure-html/unnamed-chunk-67-1.png" class="img-fluid" width="1152"></p>
</div>
</div>
<p>How many of those features had non-zero coefficients by group?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>greek_lambda <span class="ot">&lt;-</span> <span class="st">'\U03BB'</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>V1 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>V2 <span class="ot">&lt;-</span> bmodel_df_beta[bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>, ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>() <span class="sc">|&gt;</span> <span class="fu">as.data.frame.table</span>()</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>V_merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(V1, V2, <span class="at">by=</span><span class="st">'Var1'</span>, <span class="at">all=</span>T)</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(V_merged) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">'category'</span>, <span class="fu">paste</span>(greek_lambda, <span class="st">'-min'</span>, <span class="at">sep=</span><span class="st">''</span>), <span class="fu">paste</span>(greek_lambda, <span class="st">'-1se'</span>, <span class="at">sep=</span><span class="st">''</span>))</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>V_merged    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          category λ-min λ-1se
1         ATAC-seq     3     2
2        DNase-seq    24    18
3 Histone ChIP-seq   177   116
4      TF ChIP-seq   151   122</code></pre>
</div>
</div>
<p>How many non-zero coefficients between both?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>bmodel_df_beta[(bmodel_df_beta<span class="sc">$</span>V1 <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">&amp;</span> (bmodel_df_beta<span class="sc">$</span>V2 <span class="sc">!=</span> <span class="dv">0</span>), ]<span class="sc">$</span>assay <span class="sc">|&gt;</span> <span class="fu">table</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
        ATAC-seq        DNase-seq Histone ChIP-seq      TF ChIP-seq 
               1               16              101              107 </code></pre>
</div>
</div>
<div style="page-break-after: always;"></div>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sessionInfo</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.1.3 (2022-03-10)
Platform: x86_64-conda-linux-gnu (64-bit)
Running under: SUSE Linux Enterprise Server 15 SP1

Matrix products: default
BLAS/LAPACK: /lus/swift/home/temi/miniconda3/envs/r-env/lib/libopenblasp-r0.3.20.so

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] parallel  stats4    stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] doParallel_1.0.17    forcats_0.5.1        stringr_1.4.0       
 [4] dplyr_1.0.9          purrr_0.3.4          readr_2.1.2         
 [7] tidyr_1.2.0          tibble_3.1.8         ggplot2_3.3.6       
[10] tidyverse_1.3.2      reshape2_1.4.4       ROCR_1.0-11         
[13] doMC_1.3.8           iterators_1.0.14     foreach_1.5.2       
[16] glmnet_4.1-2         Matrix_1.4-1         data.table_1.14.2   
[19] R.utils_2.12.0       R.oo_1.25.0          R.methodsS3_1.8.2   
[22] reticulate_1.25      GenomicRanges_1.46.1 GenomeInfoDb_1.30.1 
[25] IRanges_2.28.0       S4Vectors_0.32.4     BiocGenerics_0.40.0 
[28] glue_1.6.2          

loaded via a namespace (and not attached):
 [1] httr_1.4.3             jsonlite_1.8.0         splines_4.1.3         
 [4] modelr_0.1.8           assertthat_0.2.1       GenomeInfoDbData_1.2.7
 [7] googlesheets4_1.0.0    cellranger_1.1.0       yaml_2.3.5            
[10] pillar_1.8.0           backports_1.4.1        lattice_0.20-45       
[13] digest_0.6.29          RColorBrewer_1.1-3     XVector_0.34.0        
[16] rvest_1.0.2            colorspace_2.0-3       htmltools_0.5.3       
[19] plyr_1.8.7             pkgconfig_2.0.3        broom_1.0.0           
[22] haven_2.5.0            zlibbioc_1.40.0        scales_1.2.0          
[25] tzdb_0.3.0             googledrive_2.0.0      generics_0.1.3        
[28] ellipsis_0.3.2         withr_2.5.0            cli_3.3.0             
[31] crayon_1.5.1           readxl_1.4.0           survival_3.3-1        
[34] magrittr_2.0.3         evaluate_0.15          fs_1.5.2              
[37] fansi_1.0.3            xml2_1.3.3             tools_4.1.3           
[40] hms_1.1.1              gargle_1.2.0           lifecycle_1.0.1       
[43] reprex_2.0.1           munsell_0.5.0          compiler_4.1.3        
[46] rlang_1.0.4            grid_4.1.3             RCurl_1.98-1.8        
[49] htmlwidgets_1.5.4      bitops_1.0-7           rmarkdown_2.14        
[52] gtable_0.3.0           codetools_0.2-18       DBI_1.1.3             
[55] R6_2.5.1               lubridate_1.8.0        knitr_1.39            
[58] fastmap_1.1.0          utf8_1.2.2             shape_1.4.6           
[61] stringi_1.7.8          Rcpp_1.0.9             vctrs_0.4.1           
[64] png_0.1-7              dbplyr_2.2.1           tidyselect_1.1.2      
[67] xfun_0.31             </code></pre>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      let href = ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>